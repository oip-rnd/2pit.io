<!-- 
/**
 * PpitCore V1.0 (https://github.com/p-pit/PpitCore)
 *
 * @link      https://github.com/p-pit/PpitCore
 * @copyright Copyright (c) 2016 Bruno Lartillot
 * @license   https://github.com/p-pit/PpitCore/blob/master/license.txt GNU-GPL license
 */
-->

<!-- Load the common form javascript functions -->
<?php echo $this->partial('/partials/common-form-js.phtml'); ?>

<?php
$title = $this->translate('P-Pit', 'ppit-core', $context->getLocale());
$this->headTitle($title);
echo $this->partial('/partials/header');
?>

<div class="container">

<!-- Front product 1 -->
<div class="row">

    <div class="col-md-6 col-md-offset-3">
        <div class="panel panel-default">
            <div class="panel-heading front-page" style="background:  <?php echo $context->getConfig('styleSheet')['panelHeadingBackground'] ?>; color: <?php echo $context->getConfig('styleSheet')['panelHeadingColor'] ?>">
                <div><?php echo $this->translate('Ethical charter', 'ppit-core', $context->getLocale()) ?></div>
            </div>
            <div class="panel-body">
       			<div>

<!-- Form header -->
<?php echo $this->partial('/partials/form-header', array(
		'update_time' => $instance->update_time,
		'message' => $message,
		'error' => $error,
		'csrfForm' => $csrfForm,
		'context' => $context,
));
?>
<?php if ($message != "OK") : ?>
					    <div class="form-group">
							<label class="col-sm-5 control-label"><?php echo $this->translate('I accept the charter', 'ppit-core', $context->getLocale())?></label>
							<div class="col-sm-7">
								<input type="checkbox" id="accept" class="form-control" value="1">
							</div>
						</div>
		
					    <div class="form-group">
							<div class="col-sm-5">&nbsp;</div>
							<div class="col-sm-7">
								<input name="submit" type="submit" id="up-submit-button" class="btn btn-warning" value="<?php echo $this->translate('Accept', 'ppit-core', $context->getLocale()) ?>">
							</div>
						</div>
<?php else : ?>
						<div style="text-align: center"><a href="<?php echo $this->url('home') ?>"><?php echo $this->translate('Home', 'ppit-core', $context->getLocale()) ?></a></div>
<?php endif;?>
		
					</form>

<!-- Display the document -->
					<div><?php echo $content ?></div>
				</div>
             </div>
        </div>
	</div>
</div>

<script>

function location_href(button, target) { 
	document.location.href=target; 
}

$('#form_action').hide();

function showForm(button, target) {

	$('#form_action').show();
	$(location).attr('hash', 'form_action');
	
	var xhttp = new XMLHttpRequest();
	xhttp.open('GET', target, true);
	xhttp.onreadystatechange = function() {
		if (xhttp.readyState == 4 <?php if (!$config['ppitCoreSettings']['isTraceActive']) echo '&& xhttp.status == 200' ?>) {
			document.getElementById('form_action').innerHTML = xhttp.responseText;
			$('#remove-anchor').click(function() { 
				$('#form_action').hide(); 
			});
			connectInstanceTryForm();
			$('#caption').focus();
		}
	}
	xhttp.send();
}

<?php 
$properties = array();
$properties['caption'] = array('type' => 'input', 'mandatory' => true, 'maxSize' => 255);
$properties['n_title'] = array('type' => 'input', 'mandatory' => true, 'maxSize' => 255);
$properties['n_first'] = array('type' => 'input', 'mandatory' => true, 'maxSize' => 255);
$properties['n_last'] = array('type' => 'input', 'mandatory' => true, 'maxSize' => 255);
$properties['email'] = array('type' => 'email', 'mandatory' => true, 'maxSize' => 255);
$properties['tel_work'] = array('type' => 'phone', 'mandatory' => true, 'maxSize' => 255);
$properties['username'] = array('type' => 'input', 'mandatory' => true, 'maxSize' => 255);
$properties['requires_notifications'] = array('type' => 'hidden');
$properties['locale'] = array('type' => 'hidden');

echo $this->partial('/partials/check-update-properties', array('entity' => 'Instance', 'context' => $context, 'properties' => $properties)) 
?>

function connectInstanceTryForm()
{
<?php foreach ($properties as $propertyId => $property) : ?>
	<?php if ($property['type'] == 'date') : ?>
	$('#input_<?php echo $propertyId ?>').datepicker();
	<?php endif;?>
<?php endforeach ?>

	var form = document.getElementById('ppit-form');
	form.onsubmit = function(event) {

		event.preventDefault();

// Check validity
		var validity = checkInstanceUpdateProperties();

		if (validity) {

// Create a new FormData object.
			var formData = new FormData();

// Get the properties values
<?php foreach ($properties as $propertyId => $property) : ?>

	<?php if ($property['type'] == 'input' || $property['type'] == 'date' || $property['type'] == 'textarea' || $property['type'] == 'select' || $property['type'] == 'number' || $property['type'] == 'email' || $property['type'] == 'phone' || $property['type'] == 'hidden') : ?>
			formData.append('<?php echo $propertyId ?>', document.getElementById('<?php echo $propertyId ?>').value);

	<?php elseif ($property['type'] == 'checkbox') : ?>
			formData.append('<?php echo $propertyId ?>', ((document.getElementById('<?php echo $propertyId ?>').checked) ? 1 : 0));

	<?php elseif ($property['type'] == 'file') : ?>
			var fileSelect = document.getElementById('order_form');
			if (fileSelect) {
				var files = fileSelect.files;
				for (var i = 0; i < files.length; i++) {
					var file = files[i];
					formData.append('order_form', file, file.name);
				}
			}

	<?php endif ?>

<?php endforeach ?>

			var xhttp = new XMLHttpRequest();
			var route, target;
			route = '<?php echo $this->url('commitment/try') ?>';
			target = 'form_action';
			xhttp.open('POST', route, true);
			xhttp.onload = function () {
				if (xhttp.readyState == 4 <?php if (!$context->getConfig()['ppitCoreSettings']['isTraceActive']) echo '&& xhttp.status == 200' ?>) {
					document.getElementById(target).innerHTML = xhttp.responseText;
					$('#remove-anchor').click(function() { 
						$('#form_action').hide(); 
					});
					connectInstanceTryForm();
					$('#loader').removeClass('loader');
				}
			};
			
			$('#loader').addClass('loader');
			xhttp.send(formData);
		}
		else return false;
	}
}

<?php if ($fqdn == 'www.p-pit.fr') : ?>
<!-- Google analytics -->
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-82264844-1', 'auto');
ga('send', 'pageview');
<?php endif;?>

</script>